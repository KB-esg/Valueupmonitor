name: Value-Up Analysis (Claude)

on:
  # 매일 오전 10시 (KST) = 오전 1시 (UTC)
  schedule:
    - cron: '0 1 * * *'
  
  # 수동 실행
  workflow_dispatch:
    inputs:
      days:
        description: '조회 기간 (일) - period 미선택 시 사용'
        required: false
        default: '7'
      period:
        description: '기간 버튼 선택 (days보다 우선)'
        required: false
        type: choice
        options:
          - ''
          - '1주'
          - '1개월'
          - '3개월'
          - '6개월'
          - '1년'
          - '2년'
          - '3년'
          - '전체'
      max_items:
        description: '최대 분석 건수'
        required: false
        default: '10'
      analyzer:
        description: 'LLM 분석기 선택'
        required: false
        type: choice
        options:
          - 'claude'
          - 'gemini'
        default: 'claude'
      dry_run:
        description: '테스트 모드 (저장 안함)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'
  PYTHONUNBUFFERED: '1'

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gspread gspread-formatting google-auth google-auth-oauthlib google-api-python-client
          pip install pdfplumber anthropic
          # Gemini 선택 시에만 google-genai 설치
          if [ "${{ github.event.inputs.analyzer || 'claude' }}" = "gemini" ]; then
            pip install google-genai
          fi
      
      - name: Run Value-Up Analysis
        id: analysis
        env:
          # Google Sheets/Drive 인증 (서비스 계정)
          GOOGLE_SERVICE: ${{ secrets.GOOGLE_SERVICE }}
          VALUEUP_GSPREAD_ID: ${{ secrets.VALUEUP_GSPREAD_ID }}
          
          # Google Drive OAuth2 (PDF 다운로드용)
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          
          # 01_Valueup_archive 폴더 ID (하위에 ValueUp_analysis 자동 생성)
          VALUEUP_ARCHIVE_ID: ${{ secrets.VALUEUP_ARCHIVE_ID }}
          
          # LLM API 키
          ANT_ANALYTIC: ${{ secrets.ANT_ANALYTIC }}
          GEM_ANALYTIC: ${{ secrets.GEM_ANALYTIC }}
          
          # 분석기 선택 (기본값: claude)
          ANALYZER_TYPE: ${{ github.event.inputs.analyzer || 'claude' }}
          
          # 실행 옵션
          VALUEUP_DAYS: ${{ github.event.inputs.days || '7' }}
          VALUEUP_PERIOD: ${{ github.event.inputs.period }}
          VALUEUP_MAX_ITEMS: ${{ github.event.inputs.max_items || '10' }}
          VALUEUP_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        working-directory: 01_valueup_analysis
        run: |
          # period가 설정되면 days 대신 period 사용
          if [ -n "$VALUEUP_PERIOD" ]; then
            python -u main.py \
              --period "$VALUEUP_PERIOD" \
              --max-items $VALUEUP_MAX_ITEMS \
              ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
          else
            python -u main.py \
              --days $VALUEUP_DAYS \
              --max-items $VALUEUP_MAX_ITEMS \
              ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## Value-Up Analysis 실행 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 설정" >> $GITHUB_STEP_SUMMARY
          echo "- **분석기**: ${{ github.event.inputs.analyzer || 'claude' }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.period }}" ]; then
            echo "- **분석 기간**: ${{ github.event.inputs.period }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **분석 기간**: ${{ github.event.inputs.days || '7' }}일" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **최대 분석 수**: ${{ github.event.inputs.max_items || '10' }}건" >> $GITHUB_STEP_SUMMARY
          echo "- **테스트 모드**: ${{ github.event.inputs.dry_run == 'true' && '예' || '아니오' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **실행 시각**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API 설정" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.ANT_ANALYTIC }}" ]; then
            echo "- **Claude API**: 설정됨 ✅" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Claude API**: 미설정 ❌" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "${{ secrets.GEM_ANALYTIC }}" ]; then
            echo "- **Gemini API**: 설정됨 ✅" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Gemini API**: 미설정 ❌" >> $GITHUB_STEP_SUMMARY
          fi
