name: ValueUp Analysis

on:
  # 매주 월요일 오전 10시 (KST) = 일요일 새벽 1시 (UTC)
  # 모니터링 워크플로우 이후 실행
  schedule:
    - cron: '0 1 * * 0'
  
  # 수동 실행
  workflow_dispatch:
    inputs:
      days:
        description: '분석할 공시 기간 (일)'
        required: false
        default: '7'
      max_items:
        description: '최대 분석 항목 수'
        required: false
        default: '10'
      dry_run:
        description: '테스트 모드 (저장 안함)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements_analysis.txt
      
      - name: Run ValueUp Analyzer
        id: analyzer
        env:
          # Google Sheets 인증 (서비스 계정)
          GOOGLE_SERVICE: ${{ secrets.GOOGLE_SERVICE }}
          VALUEUP_GSPREAD_ID: ${{ secrets.VALUEUP_GSPREAD_ID }}
          
          # Google Drive 인증 (OAuth2 - 개인 드라이브 접근)
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          
          # Gemini API
          GEM_ANALYTIC: ${{ secrets.GEM_ANALYTIC }}
          
          # 실행 옵션
          ANALYSIS_DAYS: ${{ github.event.inputs.days || '7' }}
          ANALYSIS_MAX_ITEMS: ${{ github.event.inputs.max_items || '10' }}
          ANALYSIS_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        working-directory: 01_valueup_analysis
        run: |
          python main.py
      
      - name: Summary
        if: always()
        run: |
          echo "## ValueUp Analysis 실행 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 설정" >> $GITHUB_STEP_SUMMARY
          echo "- **분석 기간**: ${{ github.event.inputs.days || '7' }}일" >> $GITHUB_STEP_SUMMARY
          echo "- **최대 분석 수**: ${{ github.event.inputs.max_items || '10' }}건" >> $GITHUB_STEP_SUMMARY
          echo "- **테스트 모드**: ${{ github.event.inputs.dry_run == 'true' && '예' || '아니오' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **실행 시각**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 시트" >> $GITHUB_STEP_SUMMARY
          echo "- **공시 목록**: 밸류업공시목록" >> $GITHUB_STEP_SUMMARY
          echo "- **프레임워크**: Framework" >> $GITHUB_STEP_SUMMARY
          echo "- **분석 결과**: 밸류업공시분석" >> $GITHUB_STEP_SUMMARY
