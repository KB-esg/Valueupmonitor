name: KRX Value-Up Monitor

on:
  # 매주 월요일 오전 9시 (KST) = 일요일 자정 (UTC)
  schedule:
    - cron: '0 0 * * 0'
  
  # 수동 실행
  workflow_dispatch:
    inputs:
      days:
        description: '조회 기간 (일) - period 미선택 시 사용'
        required: false
        default: '7'
      period:
        description: '기간 버튼 선택'
        required: false
        type: choice
        options:
          - ''
          - '1주'
          - '1개월'
          - '3개월'
          - '6개월'
          - '1년'
          - '전체'
      max_pages:
        description: '최대 크롤링 페이지 수'
        required: false
        default: '10'
      skip_pdf:
        description: 'PDF 업로드 건너뛰기'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements_valueup_read.txt
      
      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      - name: Run Value-Up Monitor
        env:
          GOOGLE_SERVICE: ${{ secrets.GOOGLE_SERVICE }}
          VALUEUP_GSPREAD_ID: ${{ secrets.VALUEUP_GSPREAD_ID }}
          VALUEUP_ARCHIVE_ID: ${{ secrets.VALUEUP_ARCHIVE_ID }}
        working-directory: 01_valueup_monitor
        run: |
          ARGS=""
          
          # 기간 버튼 옵션
          if [ -n "${{ github.event.inputs.period }}" ]; then
            ARGS="$ARGS --period '${{ github.event.inputs.period }}'"
          else
            ARGS="$ARGS --days ${{ github.event.inputs.days || '7' }}"
          fi
          
          # 최대 페이지 옵션
          ARGS="$ARGS --max-pages ${{ github.event.inputs.max_pages || '10' }}"
          
          # PDF 건너뛰기 옵션
          if [ "${{ github.event.inputs.skip_pdf }}" == "true" ]; then
            ARGS="$ARGS --skip-pdf"
          fi
          
          echo "실행 명령: python main.py $ARGS"
          eval "python main.py $ARGS"
      
      - name: Summary
        if: always()
        run: |
          echo "## Value-Up Monitor 실행 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.period }}" ]; then
            echo "- **조회 기간**: ${{ github.event.inputs.period }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **조회 기간**: ${{ github.event.inputs.days || '7' }}일" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **최대 페이지**: ${{ github.event.inputs.max_pages || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PDF 업로드**: ${{ github.event.inputs.skip_pdf == 'true' && '건너뜀' || '활성화' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **실행 시각**: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
