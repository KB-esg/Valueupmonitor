name: KRX Value-Up Monitor

on:
  # 매주 월요일 오전 9시 (KST) = 일요일 자정 (UTC)
  schedule:
    - cron: '0 0 * * 0'
  
  # 수동 실행
  workflow_dispatch:
    inputs:
      days:
        description: '조회 기간 (일) - period 미선택 시 사용'
        required: false
        default: '7'
      period:
        description: '기간 버튼 선택 (days보다 우선)'
        required: false
        type: choice
        options:
          - ''
          - '1주'
          - '1개월'
          - '3개월'
          - '6개월'
          - '1년'
          - '2년'
          - '3년'
          - '전체'
      max_pages:
        description: '최대 크롤링 페이지 수'
        required: false
        default: '10'
      skip_pdf:
        description: 'PDF 다운로드 건너뛰기'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements_valueup_read.txt
      
      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      - name: Run Value-Up Monitor
        id: monitor
        env:
          # Google Sheets 인증 (서비스 계정)
          GOOGLE_SERVICE: ${{ secrets.GOOGLE_SERVICE }}
          VALUEUP_GSPREAD_ID: ${{ secrets.VALUEUP_GSPREAD_ID }}
          
          # Google Drive 인증 (OAuth2 - 개인 드라이브 업로드용)
          GDRIVE_REFRESH_TOKEN: ${{ secrets.GDRIVE_REFRESH_TOKEN }}
          GDRIVE_CLIENT_ID: ${{ secrets.GDRIVE_CLIENT_ID }}
          GDRIVE_CLIENT_SECRET: ${{ secrets.GDRIVE_CLIENT_SECRET }}
          VALUEUP_ARCHIVE_ID: ${{ secrets.VALUEUP_ARCHIVE_ID }}
          
          # 실행 옵션
          VALUEUP_DAYS: ${{ github.event.inputs.days || '7' }}
          VALUEUP_PERIOD: ${{ github.event.inputs.period }}
          VALUEUP_MAX_PAGES: ${{ github.event.inputs.max_pages || '10' }}
          VALUEUP_SKIP_PDF: ${{ github.event.inputs.skip_pdf || 'false' }}
          
          # 디버그 옵션
          VALUEUP_DEBUG: 'true'
          VALUEUP_DEBUG_DIR: '/tmp/krx_debug'
          
          # GitHub Actions 정보 (아티팩트 링크 생성용)
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        working-directory: 01_valueup_monitor
        run: |
          python main.py
      
      # PDF 파일 아티팩트 업로드 (Archive_pdf 폴더)
      - name: Upload PDF artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Archive_pdf
          path: 01_valueup_monitor/Archive_pdf/
          retention-days: 90
          if-no-files-found: ignore
      
      # 디버그 파일 아티팩트 업로드
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: krx_debug
          path: /tmp/krx_debug/
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Summary
        if: always()
        run: |
          echo "## Value-Up Monitor 실행 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 설정" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ github.event.inputs.period }}" ]; then
            echo "- **조회 기간**: ${{ github.event.inputs.period }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **조회 기간**: ${{ github.event.inputs.days || '7' }}일" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **최대 페이지**: ${{ github.event.inputs.max_pages || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PDF 다운로드**: ${{ github.event.inputs.skip_pdf == 'true' && '건너뜀' || '활성화' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **실행 시각**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 아티팩트" >> $GITHUB_STEP_SUMMARY
          echo "- **Archive_pdf**: PDF 파일 (90일 보관)" >> $GITHUB_STEP_SUMMARY
          echo "- **krx_debug**: 디버그 파일 (7일 보관)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Google Drive 업로드" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.GDRIVE_REFRESH_TOKEN }}" ]; then
            echo "- OAuth2 인증 활성화 ✅" >> $GITHUB_STEP_SUMMARY
          else
            echo "- OAuth2 미설정 (로컬 저장만)" >> $GITHUB_STEP_SUMMARY
          fi
