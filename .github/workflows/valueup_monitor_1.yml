name: KRX Value-Up Monitor

on:
  # 매주 월요일 오전 9시 (KST) = 일요일 자정 (UTC)
  schedule:
    - cron: '0 0 * * 0'
  
  # 수동 실행
  workflow_dispatch:
    inputs:
      days:
        description: '조회 기간 (일)'
        required: false
        default: '7'
      debug:
        description: '디버그 모드 활성화'
        required: false
        default: 'true'
        type: boolean

# 아티팩트 업로드 권한
permissions:
  contents: read
  actions: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements_valueup_read.txt
      
      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      - name: Create debug directory
        run: mkdir -p /tmp/krx_debug
      
      - name: Run Value-Up Monitor
        env:
          GOOGLE_SERVICE: ${{ secrets.GOOGLE_SERVICE }}
          VALUEUP_GSPREAD_ID: ${{ secrets.VALUEUP_GSPREAD_ID }}
          VALUEUP_ARCHIVE_ID: ${{ secrets.VALUEUP_ARCHIVE_ID }}
          VALUEUP_DAYS: ${{ github.event.inputs.days || '7' }}
          VALUEUP_DEBUG: ${{ github.event.inputs.debug || 'true' }}
          VALUEUP_DEBUG_DIR: /tmp/krx_debug
        working-directory: 01_valueup_monitor
        run: |
          python main.py
      
      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: krx-debug-${{ github.run_number }}
          path: /tmp/krx_debug/
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Summary
        if: always()
        run: |
          echo "## Value-Up Monitor 실행 완료" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **조회 기간**: ${{ github.event.inputs.days || '7' }}일" >> $GITHUB_STEP_SUMMARY
          echo "- **디버그 모드**: ${{ github.event.inputs.debug || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **실행 시각**: $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 디버그 파일" >> $GITHUB_STEP_SUMMARY
          if [ -d "/tmp/krx_debug" ] && [ "$(ls -A /tmp/krx_debug 2>/dev/null)" ]; then
            echo "디버그 파일이 Artifacts에 업로드되었습니다." >> $GITHUB_STEP_SUMMARY
            ls -la /tmp/krx_debug >> $GITHUB_STEP_SUMMARY
          else
            echo "디버그 파일이 없습니다." >> $GITHUB_STEP_SUMMARY
          fi
